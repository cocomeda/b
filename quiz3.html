<body>
    <div id="overlay" onclick="closePopup()"></div>
    <div id="popup">
        <span id="close-btn" onclick="closePopup()">×</span>
        <div id="popup-message"></div>
    </div>

    <!-- ローディング表示のためのオーバーレイ -->
    <div id="loading-overlay" style="display: none;">
        <div id="loading-message">処理中…</div>
    </div>

    <div class="quiz-container">
        <div class="quiz-question" id="question">質問がここに表示されます</div>
        <ul class="quiz-options">
            <li class="quiz-option"><img src="" alt="選択肢1"></li>
            <li class="quiz-option"><img src="" alt="選択肢2"></li>
            <li class="quiz-option"><img src="" alt="選択肢3"></li>
            <li class="quiz-option"><img src="" alt="選択肢4"></li>
        </ul>
    </div>

    <script>
        let quizzes = [];
        let currentQuiz = 0;
        const answers = [];
        let shuffledQuizzes = [];

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                document.getElementById('loading-overlay').style.display = 'block'; // Show loading screen
                await loadQuiz();
            } catch (error) {
                console.error('Error in start_aaa:', error);
            }
        });

        async function loadQuiz() {
            try {
                const response = await fetch('https://script.google.com/macros/s/AKfycbwP1OkJYftnAmAKDbA-R65xBNiiDgHOIHh5_l5HNskh-WVOVLsnDa3ZSTN5ZdZsayCU/exec');
                quizzes = await response.json();

                if (!Array.isArray(quizzes) || quizzes.length === 0) {
                    throw new Error('クイズデータが不正です。');
                }

                shuffleQuizzes(); // シャッフルを実行
                showQuiz();
            } catch (error) {
                console.error('データ取得エラー:', error);
                alert('データ取得エラーが発生しました。');
            }
        }

        function shuffleQuizzes() {
            shuffledQuizzes = quizzes.map(quiz => {
                const shuffledOptions = [...quiz.options];
                shuffleArray(shuffledOptions);
                return {
                    question: quiz.question,
                    options: shuffledOptions,
                    originalOptions: quiz.options
                };
            });
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function showQuiz() {
            document.getElementById('loading-overlay').style.display = 'none'; // Hide loading screen

            const quiz = shuffledQuizzes[currentQuiz];
            document.getElementById('question').innerText = quiz.question;
            const optionsElems = document.querySelectorAll('.quiz-option img');
            
            optionsElems.forEach((optionElem, index) => {
                optionElem.src = quiz.options[index];
                optionElem.parentElement.onclick = () => answerQuestion(quiz.originalOptions.indexOf(quiz.options[index]));
            });

            document.querySelector('.quiz-container').style.display = 'block';
        }

        function answerQuestion(index) {
            answers[currentQuiz] = index;
            currentQuiz++;
            if (currentQuiz < shuffledQuizzes.length) {
                showQuiz();
            } else {
                initializeLiff0003(); // 最後の問題が答えられたら自動で送信
            }
        }

        function showPopup(message) {
            document.getElementById('popup-message').innerText = message;
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('popup').style.display = 'block';
        }

        function closePopup() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('popup').style.display = 'none';
            
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 2000); // 2秒後にリダイレクト
        }

        function showLoading() {
            document.getElementById('loading-overlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        function initializeLiff0003() {
            liff.init({ liffId: '1657196041-0B5JEMmG' })
                .then(() => {
                    if (liff.isLoggedIn()) {
                        sendIdTokenToGAS_00A3();
                    } else {
                        liff.login();
                    }
                })
                .catch(error => {
                    console.error('LIFFの初期化エラー:', error);
                    alert('LIFFの初期化に失敗しました。');
                });
        }

        async function sendIdTokenToGAS_00A3() {
            try {
                showLoading();
                const idToken = await liff.getIDToken();
                const adjustedAnswers = answers.map(answer => answer + 1);
                
                const response = await fetch('https://script.google.com/macros/s/AKfycbySNNEnQt9_g_GcbdsK5Uw1aTpVsEau9ttbuXwfZCh8CeDB0lN_Npsp_W9kj8q5x8XjeA/exec', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: JSON.stringify({
                        'idToken': idToken,
                        'answers': adjustedAnswers
                    })
                });

                if (!response.ok) {
                    console.error('HTTPエラー:', response.status);
                    alert('HTTPエラーが発生しました。ステータスコード: ' + response.status);
                    return;
                }

                const data = await response.json();
                if (data.status === 'success') {
                    showPopup(data.message);
                } else {
                    showPopup('エラー: ' + data.message);
                }
            } catch (error) {
                console.error('通信エラー:', error);
                alert('通信エラーが発生しました。');
            } finally {
                hideLoading();
            }
        }
    </script>
</body>
</html>



