<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz</title>
    <style>
        /* スタイルは適宜追加 */
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="overlay" onclick="closePopup()"></div>
    <div id="popup">
        <span id="close-btn" onclick="closePopup()">×</span>
        <div id="popup-message"></div>
    </div>

    <!-- ローディング表示のためのオーバーレイ -->
    <div id="loading-overlay" style="display: none;">
        <div id="loading-message">処理中…</div>
    </div>

    <div class="quiz-container">
        <div class="quiz-question" id="question">質問がここに表示されます</div>
        <ul class="quiz-options">
            <li class="quiz-option"><img src="" alt="選択肢1"></li>
            <li class="quiz-option"><img src="" alt="選択肢2"></li>
            <li class="quiz-option"><img src="" alt="選択肢3"></li>
            <li class="quiz-option"><img src="" alt="選択肢4"></li>
        </ul>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                showLoading(); // ローディング表示
                await loadQuiz();
            } catch (error) {
                console.error('Error in start_aaa:', error);
                alert('データ取得エラーが発生しました。');
            }
        });

        async function loadQuiz() {
            try {
                const response = await fetch('https://script.google.com/macros/s/AKfycbwP1OkJYftnAmAKDbA-R65xBNiiDgHOIHh5_l5HNskh-WVOVLsnDa3ZSTN5ZdZsayCU/exec'); // GASのウェブアプリのURLに置き換えてください
                const quizzes = await response.json();

                if (!Array.isArray(quizzes) || quizzes.length === 0) {
                    throw new Error('クイズデータが不正です。');
                }

                loadQuiz2(quizzes);
            } catch (error) {
                console.error('データ取得エラー:', error);
                alert('データ取得エラーが発生しました。');
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function loadQuiz2(quizzes) {
            hideLoading(); // ローディング表示を非表示

            const questionElem = document.getElementById('question');
            const optionsElem = document.querySelectorAll('.quiz-option img');
            const quiz = quizzes[currentQuiz];

            questionElem.innerText = quiz.question;
            
            // シャッフルされたオプションのリストを作成
            const shuffledOptions = [...quiz.options];
            shuffleArray(shuffledOptions);

            // シャッフルされた画像と元の解答番号のマップを作成
            const optionIndexMap = shuffledOptions.map(opt => quiz.options.indexOf(opt));

            optionsElem.forEach((optionElem, index) => {
                optionElem.src = shuffledOptions[index];
                optionElem.parentElement.onclick = () => answerQuestion(optionIndexMap[index]);
                optionElem.parentElement.classList.remove('disabled'); // Enable all options
            });
            
            questionElem.classList.remove('hidden');
            optionsElem.forEach(elem => elem.parentElement.classList.remove('hidden'));
        }

        function answerQuestion(selectedIndex) {
            answers[currentQuiz] = selectedIndex;
            currentQuiz++;
            if (currentQuiz < quizzes.length) {
                loadQuiz2(quizzes); // 次の問題を表示
            } else {
                initializeLiff0003(); // 全問終了後にLIFFを初期化
            }
        }

        function showPopup(message) {
            document.getElementById('popup-message').innerText = message;
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('popup').style.display = 'block';
        }

        function closePopup() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('popup').style.display = 'none';
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 2000); // 2秒後にリダイレクト
        }

        function showLoading() {
            document.getElementById('loading-overlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        async function initializeLiff0003() {
            liff.init({ liffId: '1657196041-0B5JEMmG' })
                .then(() => {
                    if (liff.isLoggedIn()) {
                        sendIdTokenToGAS_00A3(); // IDトークンをGASに送信する関数を呼び出す
                    } else {
                        liff.login(); // ログインしていない場合はログインページにリダイレクト
                    }
                })
                .catch(error => {
                    console.error('LIFFの初期化エラー:', error);
                    alert('LIFFの初期化に失敗しました。');
                });
        }

        async function sendIdTokenToGAS_00A3() {
            try {
                showLoading(); // ローディング表示

                const idToken = await liff.getIDToken();
                const adjustedAnswers = answers.map(answer => answer + 1);
                
                const response = await fetch('https://script.google.com/macros/s/AKfycbySNNEnQt9_g_GcbdsK5Uw1aTpVsEau9ttbuXwfZCh8CeDB0lN_Npsp_W9kj8q5x8XjeA/exec', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: JSON.stringify({
                        'idToken': idToken,
                        'answers': adjustedAnswers // JSON形式で送信
                    })
                });

                if (!response.ok) {
                    console.error('HTTPエラー:', response.status);
                    alert('HTTPエラーが発生しました。ステータスコード: ' + response.status);
                    return;
                }

                const data = await response.json();
                if (data.status === 'success') {
                    showPopup(data.message);
                } else {
                    showPopup('エラー: ' + data.message);
                }
            } catch (error) {
                console.error('通信エラー:', error);
                alert('通信エラーが発生しました。');
            } finally {
                hideLoading(); // ローディング表示を非表示
            }
        }
    </script>
</body>
</html>
